#!/bin/bash

install_shim_if_uefi() {
    # Comprobar si el sistema usa UEFI
    if [ ! -d /sys/firmware/efi ]; then
        echo "Sistema no UEFI, no se requiere 'shim-signed'."
        return 0
    fi

    # Detectar estado de shim-signed (ii = instalado, rc = eliminado con configs)
    PKG_STATUS=$(dpkg -l shim-signed 2>/dev/null | awk '/^(ii|rc)/ {print $1}')

    # Comprobar si hay ESP real
    EFI_DISK=$(findmnt -n -o SOURCE /boot/efi 2>/dev/null | sed 's/[0-9]*$//')

    if [ -z "$EFI_DISK" ]; then
        echo "⚠ No se detectó disco EFI."

        # Si shim-signed está instalado, desinstalarlo junto con dependencias esenciales
        if [[ "$PKG_STATUS" == "ii" ]]; then
            echo "'shim-signed' está instalado pero no hay ESP. Procediendo a desinstalar..."
            export DEBIAN_FRONTEND=noninteractive
            apt-get remove --purge -y --allow-remove-essential shim-signed grub-efi-amd64-signed mokutil || true
            apt-get autoremove -y
            unset DEBIAN_FRONTEND
            echo "✔ 'shim-signed' desinstalado correctamente."
        else
            echo "✔ 'shim-signed' no está instalado. No se realiza ninguna acción."
        fi

        return 0
    fi

    # Si shim-signed ya está instalado, no hacer nada
    if [[ "$PKG_STATUS" == "ii" ]]; then
        echo "'shim-signed' ya está instalado. No se realizará ninguna acción."
        return 0
    fi

    # Si shim-signed no está instalado, proceder con instalación/reinstalación
    echo "Disco EFI detectado: $EFI_DISK"
    echo "'shim-signed' no está instalado. Preparando instalación manual con dependencias..."

    # Preparar directorio temporal
    TMPDIR=$(mktemp -d)
    cd "$TMPDIR" || return 1

    # Actualizar lista de paquetes
    apt-get update -qq

    # Obtener shim-signed y todas sus dependencias automáticamente
    PACKAGES=$(LC_ALL=C apt-cache depends shim-signed  | awk '/Depends:/ {print $2}'  | grep -v '^<.*>$')
    PACKAGES="shim-signed $PACKAGES"

    echo "Descargando paquetes: $PACKAGES"
    for pkg in $PACKAGES; do
        if ! apt-get download "$pkg" >/dev/null 2>&1; then
            echo "✖ Error descargando $pkg"
            rm -rf "$TMPDIR"
            return 1
        fi
    done

    # Crear tmpfs temporal para evitar error 32 en post-install de GRUB
    mkdir -p /var/lib/grub/esp
    mount -t tmpfs tmpfs /var/lib/grub/esp || { echo "⚠ No se pudo montar tmpfs en /var/lib/grub/esp"; rm -rf "$TMPDIR"; return 1; }
    ESP_TMPFS=1

    echo "Ejecutando grub-install en modo no interactivo..."
    grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=GRUB --recheck --no-floppy "$EFI_DISK" || {
        echo "⚠ No se pudo ejecutar grub-install correctamente."
    }

    # Instalar paquetes descargados en modo no interactivo
    export DEBIAN_FRONTEND=noninteractive
    DEB_FILES=$(find "$TMPDIR" -maxdepth 1 -type f -name "*.deb")
    dpkg -i $DEB_FILES || true

    # Resolver dependencias automáticamente
    apt-get install -f -y
    unset DEBIAN_FRONTEND

    # Verificar instalación
    if dpkg -s shim-signed >/dev/null 2>&1; then
        echo "✔ 'shim-signed' y sus dependencias instaladas correctamente."
    else
        echo "✖ Falló la instalación de 'shim-signed'."
        umount /var/lib/grub/esp
        rm -rf "$TMPDIR"
        return 1
    fi

    # Limpiar temporales
    rm -rf "$TMPDIR"
    [ "$ESP_TMPFS" -eq 1 ] && umount /var/lib/grub/esp && echo "⚠ Desmontado tmpfs temporal en /var/lib/grub/esp"
}

install_shim_if_uefi
