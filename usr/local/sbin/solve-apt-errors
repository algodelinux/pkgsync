#!/bin/bash
# solve-apt-errors - Trata de resolver posibles errores de apt
# 2013-2019 Esteban M. Navas Martín <algodelinux@gmail.com>.
#

killprocess() {
   
   updatehour=$(ps aux|grep $1 | grep -v grep | head -1 | awk '{print $9}')
   if [ -n $updatehour ]; then
      timestampupdate=$(date -d "$updatehour" +'%s')
      timestampnow=$(date +'%s')
      diference=$(($timestampnow - $timestampupdate))
      minutesfromupdate=$(($diference / 60))

      if [ "$minutesfromupdate" -gt "$MAXMINUTES_FROM_FIRST_UPDATE_COMMAND" ]; then
         # Matamos procesos de actualización de paquetes
         killall $1 2>/dev/null
      fi
   fi
}

idioma=$LC_ALL
export LC_ALL=C

MAXMINUTES_FROM_FIRST_UPDATE_COMMAND='1'
TIMEOUT_FOR_DPKG_OR_APT="10s"

# Matamos procesos detenidos
stopped_processes=$(ps auwx | awk 'NR>1 && $8 ~ "T" {print $2}')
if [ "$stopped_processes" ]; then kill -9 $stopped_processes; fi

apt-get check 1>/dev/null 2>/tmp/apterrors

if [ -n "$(grep 'Unable to acquire the dpkg frontend lock' /tmp/apterrors)" ]; then
   if [ $(pgrep -c aptitude) -gt 0 ]; then killprocess aptitude; fi
   if [ $(pgrep -c apt-get) -gt 0 ]; then killprocess apt-get; fi
   if [ $(pgrep -c dpkg) -gt 0 ]; then killprocess dpkg; fi
fi

if [ -s /tmp/apterrors ]; then
     timeout $TIMEOUT_FOR_DPKG_OR_APT wait_for_apt_or_dpkg
     grep "Unmet dependencies." /tmp/apterrors 2>/dev/null && aptitude -yf install && dpkg --configure -a && apt-get -y autoremove
     grep "dpkg was interrupted, you must manually run 'dpkg --configure -a' to correct the problem." /tmp/apterrors 2>/dev/null && dpkg --configure -a && aptitude -yf install && apt-get -y autoremove
     grep -E 'Encountered a section with no Package: header|Problem with MergeList ' /tmp/apterrors 2>/dev/null && rm -rf /var/lib/apt/lists/
fi

export LC_ALL=$idioma

