#!/bin/bash
# solve-apt-errors - Trata de resolver posibles errores de apt
# 2013-2023 Esteban M. Navas Martín <algodelinux@gmail.com>.
#

killprocess() {

   updatehour=$(ps aux|grep $1 | grep -v grep | head -1 | awk '{print $9}')
   if [ -n $updatehour ]; then
      timestampupdate=$(date -d "$updatehour" +'%s')
      timestampnow=$(date +'%s')
      diference=$(($timestampnow - $timestampupdate))
      minutesfromupdate=$(($diference / 60))

      if [ "$minutesfromupdate" -gt "$2" ]; then
         # Matamos proceso
         pkill -9 $1 2>/dev/null
      fi
   fi
}

RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

if (( $EUID != 0 )); then
   echo -e "${RED}Please run with SUDO or root user account${NC}"
   exit 1
fi

idioma=$LC_ALL
export LC_ALL=C
export DEBIAN_FRONTEND=noninteractive

if [ -f /etc/default/pkgsync ]; then
   TIMEOUT_FOR_DPKG_OR_APT=$(grep -v "^#" /etc/default/pkgsync | sed -n 's|TIMEOUT_FOR_DPKG_OR_APT="\(.*\)"|\1|p')
   TIMEOUT_FOR_SINC_PUPPET=$(grep -v "^#" /etc/default/pkgsync | sed -n 's|TIMEOUT_FOR_SINC_PUPPET="\(.*\)"|\1|p')
fi

if [ -s "$TIMEOUT_FOR_DPKG_OR_APT" ]; then
   TIMEOUT_UNITS=${TIMEOUT_FOR_DPKG_OR_APT: -1}
   TIMEOUT_NUMBER=${TIMEOUT_FOR_DPKG_OR_APT:: -1}
fi

case "$TIMEOUT_UNITS" in

"s")  AFTER_TIMEOUT=$TIMEOUT_NUMBER
    ;;
"m")  AFTER_TIMEOUT=$(($TIMEOUT_NUMBER * 60))
    ;;
"h")  AFTER_TIMEOUT=$((expr $TIMEOUT_NUMBER * 3600))
    ;;
"d")  AFTER_TIMEOUT=$((expr $TIMEOUT_NUMBER * 86400))
   ;;
esac

if [ "$1" == "-f" ]; then
   $TIMEOUT_FOR_SINC_PUPPET=0
   $AFTER_TIMEOUT=0
fi

# Matamos procesos detenidos
stopped_processes=$(ps auwx | awk 'NR>1 && $8 ~ "T" {print $2}')
if [ "$stopped_processes" ]; then kill -9 $stopped_processes; fi

# Matamos sinc_puppet si está corriendo desde hace más de xx minutos
if [ $(pgrep -c sinc_puppet) -gt 0 ]; then killprocess sinc_puppet $TIMEOUT_FOR_SINC_PUPPET; fi

apt-get check 1>/dev/null 2>/tmp/apterrors

if [ -n "$(grep 'Unable to acquire the dpkg frontend lock' /tmp/apterrors)" ]; then
   if [ $(pgrep -c aptitude) -gt 0 ]; then killprocess aptitude $AFTER_TIMEOUT; fi
   if [ $(pgrep -c apt-get) -gt 0 ]; then killprocess apt-get $AFTER_TIMEOUT; fi
   if [ $(pgrep -c dpkg) -gt 0 ]; then killprocess dpkg $AFTER_TIMEOUT; fi
fi

if [ -s /tmp/apterrors ]; then
   grep "Unmet dependencies." /tmp/apterrors 2>/dev/null && [ -x /usr/local/sbin/wait_for_apt_or_dpkg ] && timeout $TIMEOUT_FOR_DPKG_OR_APT /usr/local/sbin/wait_for_apt_or_dpkg; aptitude -yf install && [ -x /usr/local/sbin/wait_for_apt_or_dpkg ] && timeout $TIMEOUT_FOR_DPKG_OR_APT /usr/local/sbin/wait_for_apt_or_dpkg; dpkg --configure -a
   grep "dpkg was interrupted, you must manually run 'dpkg --configure -a' to correct the problem." /tmp/apterrors 2>/dev/null && [ -x /usr/local/sbin/wait_for_apt_or_dpkg ] && timeout $TIMEOUT_FOR_DPKG_OR_APT /usr/local/sbin/wait_for_apt_or_dpkg; dpkg --configure -a && [ -x /usr/local/sbin/wait_for_apt_or_dpkg ] && timeout $TIMEOUT_FOR_DPKG_OR_APT /usr/local/sbin/wait_for_apt_or_dpkg; aptitude -yf install 
   grep -E 'Encountered a section with no Package: header|Problem with MergeList ' /tmp/apterrors 2>/dev/null && rm -r /var/lib/apt/lists/*; [ -x /usr/local/sbin/wait_for_apt_or_dpkg ] && timeout $TIMEOUT_FOR_DPKG_OR_APT /usr/local/sbin/wait_for_apt_or_dpkg; apt update -y; [ -x /usr/local/sbin/wait_for_apt_or_dpkg ] && timeout $TIMEOUT_FOR_DPKG_OR_APT /usr/local/sbin/wait_for_apt_or_dpkg; dpkg --configure -a; [ -x /usr/local/sbin/wait_for_apt_or_dpkg ] && timeout $TIMEOUT_FOR_DPKG_OR_APT /usr/local/sbin/wait_for_apt_or_dpkg; aptitude -yf install
fi

# Desinstalamos paquetes en estado de inconsistencia
inconsistent_packages=$(dpkg -l|grep ^iU | awk '{print $2}')
if [ "$inconsistent_packages" ]; then dpkg --remove --force-remove-reinstreq $inconsistent_packages; fi

# Reinstalamos paquetes a medio instalar o los desinstalamos si no se pueden reinstalar
bad_packages=$(dpkg -l | grep -e ^iF -e ^ri | awk '{print $2}')
if [ "$bad_packages" ]; then
   apt-get -y install $bad_packages
   bad_packages=$(dpkg -l | grep -e ^iF -e ^ri | awk '{print $2}')
   if [ "$bad_packages" ]; then
      apt-get remove -y $bad_packages
      if [ $? -ne 0]; then
         dpkg --purge --force-all $bad_packages
      fi
   fi
fi

# Aseguramos la actualización de pkgsync
apt-cache search '~U' | grep -oE pkgsync >/dev/null 2>&1 && apt-get install -y pkgsync

export LC_ALL=$idioma
